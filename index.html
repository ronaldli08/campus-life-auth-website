<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification - Campus Life</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: #1e293b;
        }
        
        .container {
            background: #ffffff;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        
        .logo {
            width: 64px;
            height: 64px;
            background: #60a5fa;
            border-radius: 12px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 24px;
        }
        
        h1 {
            color: #1e293b;
            margin-bottom: 12px;
            font-size: 32px;
            font-weight: 900;
            letter-spacing: -0.025em;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 32px;
        }
        
        .status-message {
            margin: 24px 0;
            padding: 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .loading {
            background: #f0f9ff;
            color: #3b82f6;
            border: 2px solid #e0e7ff;
        }
        
        .success {
            background: #f0fdf4;
            color: #10b981;
            border: 2px solid #d1fae5;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            border: 2px solid #fecaca;
        }
        
        .status-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .status-description {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .status-subtitle {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.8;
        }
        
        .button {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 16px 24px;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            margin: 16px 8px;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
            cursor: pointer;
        }
        
        .button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .secondary-button {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            margin: 8px;
            transition: background-color 0.2s, border-color 0.2s;
        }
        
        .secondary-button:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 16px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .countdown {
            color: #3b82f6;
            font-weight: 600;
        }
        
        footer {
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }
        
        footer .support {
            margin-top: 8px;
            color: #94a3b8;
            font-size: 12px;
        }
        
        @media (max-width: 480px) {
            body {
                padding: 16px;
            }
            
            .container {
                padding: 24px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            .logo {
                width: 56px;
                height: 56px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">CL</div>
        <h1>Campus Life</h1>
        <div class="subtitle">Connecting families through wellness</div>
        
        <!-- Loading State -->
        <div id="loading-state">
            <div class="status-message loading">
                <div class="spinner"></div>
                <div class="status-title">Verifying Email</div>
                <div class="status-description">Please wait while we process your verification</div>
            </div>
        </div>
        
        <!-- Success State -->
        <div id="success-state" class="hidden">
            <div class="status-message success">
                <div class="status-title" id="success-title">Email Verified Successfully</div>
                <div class="status-description" id="success-message">Your Campus Life account is now active</div>
                <div class="status-subtitle" id="countdown-container">
                    Redirecting to app in <span id="countdown" class="countdown">5</span> seconds...
                </div>
            </div>
            <a href="" id="success-button" class="button">Open Campus Life App</a>
            <button onclick="copyAppLink()" id="copy-button" class="secondary-button">Copy App Link</button>
        </div>
        
        <!-- Error State -->
        <div id="error-state" class="hidden">
            <div class="status-message error">
                <div class="status-title">Verification Failed</div>
                <div class="status-description" id="error-message">
                    The verification link is invalid or has expired
                </div>
                <div class="status-subtitle">Please request a new verification email from the app</div>
            </div>
            <a href="campuslife://verification-failed" class="button">Return to App</a>
            <button onclick="location.reload()" class="secondary-button">Try Again</button>
        </div>
        
        <footer>
            <div>Campus Life</div>
            <div class="support">Having trouble? Contact support at help@campus-life.app</div>
        </footer>
    </div>

    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        window.firebaseApp = { initializeApp, getFirestore, doc, getDoc, updateDoc };
    </script>

    <script>
        // Extract token from URL path
        const pathParts = window.location.pathname.split('/');
        const verificationType = pathParts[pathParts.length - 2]; // email_verification or password_reset
        const token = pathParts[pathParts.length - 1];
        
        console.log('Verification type:', verificationType, 'Token:', token);
        
        // Verify the token with Firebase (client-side)
        async function verifyToken() {
            try {
                console.log('Starting verification for:', { token, verificationType });
                
                // Wait for Firebase modules to load
                while (!window.firebaseApp) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const { initializeApp, getFirestore, doc, getDoc, updateDoc } = window.firebaseApp;
                
                // Initialize Firebase
                const firebaseConfig = {
                    apiKey: "AIzaSyC8j70Zk-rxngvd6eOHlrsQ0dIePKj4nks",
                    authDomain: "campus-life-b0fd3.firebaseapp.com",
                    projectId: "campus-life-b0fd3",
                    storageBucket: "campus-life-b0fd3.firebasestorage.app",
                    messagingSenderId: "1028408297935",
                    appId: "1:1028408297935:web:45a5f47a3a2d14f7482aba",
                };

                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                
                console.log('Firebase initialized, checking token...');
                
                // Get verification token from Firestore
                const tokenDoc = await getDoc(doc(db, 'verification_tokens', token));
                
                if (!tokenDoc.exists()) {
                    console.log('Token not found in database');
                    showError('Invalid verification link');
                    return;
                }
                
                const tokenData = tokenDoc.data();
                console.log('Token data:', tokenData);
                
                // Check if token is already used
                if (tokenData.used) {
                    showError('This verification link has already been used');
                    return;
                }
                
                // Check if token is expired
                if (tokenData.expires_at.toDate() < new Date()) {
                    showError('This verification link has expired');
                    return;
                }
                
                // Check if token type matches
                if (tokenData.type !== verificationType) {
                    showError('Invalid verification link type');
                    return;
                }
                
                console.log('Token is valid, updating database...');
                
                if (verificationType === 'email_verification') {
                    // Mark token as used for email verification only
                    await updateDoc(doc(db, 'verification_tokens', token), { used: true });
                    
                    // Mark user as verified
                    await updateDoc(doc(db, 'users', tokenData.user_id), {
                        email_verified: true,
                        updated_at: new Date()
                    });
                    
                    // Also update profiles collection if it exists
                    try {
                        await updateDoc(doc(db, 'profiles', tokenData.user_id), {
                            email_verified: true,
                            updated_at: new Date()
                        });
                        console.log('Profile updated successfully');
                    } catch (profileError) {
                        console.log('Profile update skipped (might not exist)');
                    }
                    
                    console.log('Email verification complete!');
                    showSuccess('email_verification');
                    startCountdown('campuslife://verified');
                } else if (verificationType === 'password_reset') {
                    // Don't mark password reset tokens as used here - they get consumed when password is actually changed
                    console.log('Password reset token verified, redirecting to app');
                    showSuccess('password_reset', token);
                    startCountdown(`campuslife://reset-password/${token}`);
                }
                
            } catch (error) {
                console.error('Verification error:', error);
                showError('Verification failed: ' + error.message);
            }
        }
        
        function showSuccess(type, resetToken = null) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('success-state').classList.remove('hidden');
            
            if (type === 'password_reset') {
                document.getElementById('success-title').textContent = 'Password Reset Link Verified';
                document.getElementById('success-message').textContent = 'Click the button below to set your new password';
                document.getElementById('countdown-container').innerHTML = 'Redirecting to set your new password in <span id="countdown" class="countdown">5</span> seconds...';
                document.getElementById('success-button').textContent = 'Set New Password';
                document.getElementById('copy-button').style.display = 'none';
            } else {
                document.getElementById('success-title').textContent = 'Email Verified Successfully';
                document.getElementById('success-message').textContent = 'Your Campus Life account is now active';
                document.getElementById('countdown-container').innerHTML = 'Redirecting to app in <span id="countdown" class="countdown">5</span> seconds...';
                document.getElementById('success-button').textContent = 'Open Campus Life App';
                document.getElementById('copy-button').style.display = 'inline-block';
            }
        }
        
        function showError(message) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }
        
        function startCountdown(redirectUrl) {
            let seconds = 5;
            const countdownElement = document.getElementById('countdown');
            
            // Update the button href
            document.getElementById('success-button').href = redirectUrl;
            
            const countdown = setInterval(() => {
                seconds--;
                countdownElement.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(countdown);
                    window.location.href = redirectUrl;
                }
            }, 1000);
        }
        
        function copyAppLink() {
            navigator.clipboard.writeText('campuslife://verified').then(() => {
                alert('App link copied to clipboard!');
            }).catch(() => {
                alert('Could not copy link. Please open the Campus Life app manually.');
            });
        }
        
        // Start verification when page loads
        if (token && token !== 'undefined' && token !== '') {
            verifyToken();
        } else {
            showError('Invalid verification link. Please check the link and try again.');
        }
        
        // Handle app not installed case
        setTimeout(() => {
            // If user is still on page after trying to open app, show install message
            const installMessage = document.createElement('div');
            installMessage.innerHTML = `
                <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 10px; color: #92400e;">
                    <strong>App not installed?</strong><br>
                    <small>Download Campus Life from the App Store or Google Play</small>
                </div>
            `;
            // Don't show this for now - only if needed
        }, 8000);
    </script>
</body>
</html>